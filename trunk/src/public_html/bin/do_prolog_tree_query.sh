#!/bin/bash
#Brandon Chisham
#Script to extract a prolog format tree.
#-->Params
#----->$1 database configuration string
#----->$2 tree name
#----->$3 xml base.
#----->$4 directed/undirected 
#Note do_query.py expects DBCONFIG_STRING QUERY_STRING FORMAT_STRING XML_BASE_URI

export cdao="http://www.evolutionaryontology.org/cdao.owl"
export CDAO_STORE_URI="http://www.cs.nmsu.edu/~bchisham/cdao-store"
export CDAONS="$cdao#"
export GRAPH_CONFIG="$1"
export TREE_NAME="$2"
export XMLNS="$3"
export TYPE="$4"

function node_query {
cat << EOM
SELECT ?node 
 WHERE {
              {
                ?node cdao:part_of <$XMLNS$TREE_NAME>.  
                ?node rdf:type cdao:Node . 
              } 
              UNION 
              { 
                ?node cdao:part_of <$XMLNS$TREE_NAME>. 
                ?edge cdao:has_Child_Node ?node.  
              } 
              UNION 
              { 
                ?node cdao:part_of <$XMLNS$TREE_NAME>. 
                ?edge cdao:has_Parent_Node ?node. 
              } 
            }


EOM
}

function edge_query {
cat << EOM
SELECT ?edge ?src ?dest 
      WHERE 
      { 
         ?dest cdao:part_of <$XMLNS$TREE_NAME>.
         ?src cdao:part_of <$XMLNS$TREE_NAME>.
         ?edge cdao:has_Child_Node ?dest .
         ?edge cdao:has_Parent_Node ?src .
       }

EOM
}

export NODE_QUERY=`node_query`
export EDGE_QUERY=`edge_query`
export CTIME=`date`
echo -e "%Generated by: Cdao-Store on: $CTIME"

echo -e "/*$NODE_QUERY*/"
echo -e "/*$EDGE_QUERY*/"
echo -e "/*$XMLNS*/"

echo -e "/*format: generator( 'system name', 'URI', 'date'  ).
                   namespace( 'shortname', 'URI' ).
                   node( TREE_NAME, TU_NAME, NODE_NAME). 
                   edge( TREE_NAME, TREE_TYPE, EDGE_NAME, PARENT, CHILD ).*/"
echo "generator('cdao-store', '$CDAO_STORE_URI', '$CTIME')."
echo "namespace( '$TREE_NAME', '$XMLNS' )."
echo "namespace( 'cdao', '$CDAONS' )."
do_query.py "$GRAPH_CONFIG" "$XMLNS" "$NODE_QUERY" "node( '$TREE_NAME', '%s' )." "$EDGE_QUERY" "edge( '$TREE_NAME', '$TYPE', '%s', '%s', '%s')."
