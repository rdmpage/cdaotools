#!/bin/bash
#Brandon Chisham
#March 22, 2010
#Script to implement Phylows version of the NCA query.

#source /home/grad6/bchisham/.bashrc
source "phylows.env"
set_mime_type "text/xml"
#init_pylows_env "nca"

TREE_NAME=$(set_tree_name "nca")
#FILE_NAME=$(set_file_name "$TREE_NAME")
#XMLNS=$(set_xmlns "$FILE_NAME")
#EXMLNS=$( set_exmlns "$FILE_NAME" )
#NODE_SET=$( set_node_set "$TREE_NAME" )
#TREE_NAME=$(echo $REQUEST_URI | grep -oE "nca/[a-zA-Z0-9]*/" | sed 's/nca\///' | sed 's/\/$//g' )
FILE_NAME=$(grep "$TREE_NAME" tree_to_file.dat | cut -d' ' --fields=1 )
XMLNS="http://www.cs.nmsu.edu/~cdaostore/cgi-bin/phylows/tree/"
EXMLNS="http:\/\/www.cs.nmsu.edu\/~cdaostore\/cgi-bin\/phylows\/tree\/$TREE_NAME#"

NODE_SET=$(echo $REQUEST_URI | grep -oE "$TREE_NAME/.*$" | sed "s/$TREE_NAME//" | sed "s/\// $EXMLNS/g")
CSV_NODE_SET=$( echo $NODE_SET | sed "s/ /','/g" | sed "s/,$//" )
CSV_NODE_SET="'$CSV_NODE_SET'"


NODE_COUNT=$(echo "$NODE_SET" | wc -w )

#echo -e "Content-type: text/xml; charset: utf-8\nServer: Cdao-Store\nExpires: Fri, Dec 31 9999 23:59 GMT\n\n"

#echo "TREE_NAME: $TREE_NAME"


NODE_QUERY=$(do_node_query_construct.sh "$XMLNS$TREE_NAME" )
EDGE_QUERY=$(do_edge_query_construct.sh "$XMLNS$TREE_NAME" )

TMP_PROLOG_IN=`mktemp | sed 's/\///'`
TMP_PROLOG_BIN=`mktemp | sed 's/\///' `
#TMP_PROLOG_OUT=`mktemp`

curl "$XMLNS/$TREE_NAME?format=prolog"
#curl "http://$SERVER_NAME$(echo $REQUEST_URI | sed 's/nca\/.*/tree/')/$TREE_NAME?format=prolog" >> "$TMP_PROLOG_IN"

NCA_PRED_HEAD="nearest_common_ancestor_of( Tree, Ancestor "
DIS_PRED_HEAD="distant_common_ancestor_of( Tree, Ancestor "
COMMON_ANCESTOR_OF="common_ancestor_of( Tree, Ancestor "
CSV_NODE_VARS=""
COMMON_ANCESTOR_TAIL=""
for i in $(seq 1 $NODE_COUNT); do 
	CSV_NODE_VARS="$CSV_NODE_VARS,N$i"
	COMMON_ANCESTOR_TAIL="$COMMON_ANCESTOR_TAIL, ancestor_of( Tree, Ancestor, N$i )"
done
COMMON_ANCESTOR_TAIL=$(echo "$COMMON_ANCESTOR_TAIL" | sed "s/,//" )
COMMON_ANCESTOR_OF="$COMMON_ANCESTOR_OF $CSV_NODE_VARS ):- $COMMON_ANCESTOR_TAIL."
DIS_PRED_HEAD="$DIS_PRED_HEAD $CSV_NODE_VARS )"
DIS_CA_OF="$DIS_PRED_HEAD:- ancestor_of(Tree, Ancestor, Intermediate), common_ancestor_of( Tree,  Intermediate $CSV_NODE_VARS )."
NCA_OF="$NCA_PRED_HEAD $CSV_NODE_VARS ):- common_ancestor_of( Tree, Ancestor $CSV_NODE_VARS ), \+  $DIS_PRED_HEAD."
PROLOG_QUERY="nearest_common_ancestor_of( '$TREE_NAME', Ancestor, $CSV_NODE_SET )."

echo $COMMON_ANCESTOR_OF >> "$TMP_PROLOG_IN"
echo $DIS_CA_OF >> "$TMP_PROLOG_IN"
echo $NCA_OF    >> "$TMP_PROLOG_IN"

#cat "$TMP_PROLOG_IN"

pl -o "$TMP_PROLOG_BIN" -c "$TMP_PROLOG_IN"

PROLOG_OUT=$(echo -e "$PROLOG_QUERY\nhalt.\n" | "./$TMP_PROLOG_BIN" 2>&1 | grep "Ancestor"  | grep -oE "http://[-_.~/#a-zA-Z0-9]*" )
#echo $PROLOG_QUERY

cat << EOM
<rdf:RDF xmlns="http://$SERVER_NAME$REQUEST_URI#"
     xml:base="http://$SERVER_NAME$REQUEST_URI"
     xmlns:owl2xml="http://www.w3.org/2006/12/owl2-xml#"
     xmlns:cdao="http://www.evolutionaryontology.org/cdao.owl#"
     xmlns:xsd="http://www.w3.org/2001/XMLSchema#"
     xmlns:dc="http://purl.org/dc/elements/1.1/"
     xmlns:owl2="http://www.w3.org/2006/12/owl2#"
     xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
     xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
     xmlns:owl="http://www.w3.org/2002/07/owl#">
  <!-- NODE_QUERY: $NODE_QUERY
       EDGE_QUERY: $EDGE_QUERY -->
  <!-- NODE_SET: $NODE_SET -->
  <!-- PROLOG_QUERY: $PROLOG_QUERY -->
  <!-  Generated by: Cdao-Store phylows api -->
  <!-- Retrieved: $( date )-->
  <owl:Ontology rdf:about=""/>
  <cdao:Node rdf:about="$PROLOG_OUT">
     <cdao:nca_node_of>
        <cdao:SetOfNodes rdf:resource="#node_set">
       $( 
          for i in $(echo "$NODE_SET"); do
              echo "<cdao:has_Element rdf:resource=\"$i\"/>"
	  done
        )
       </cdao:SetOfNodes>
     </cdao:nca_node_of>
  </cdao:Node>
  <!-- PROLOG_IN: $TMP_PROLOG_IN 
       PROLOG_BIN: $TMP_PROLOG_BIN -->
</rdf:RDF>
EOM


rm -f "$TMP_PROLOG_IN" "$TMP_PROLOG_BIN"
